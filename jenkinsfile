pipeline {
    agent any
    
    environment {
        DOCKERHUB_USERNAME = "29edu"
        BACKEND_IMAGE = "${DOCKERHUB_USERNAME}/fullstack-backend"
        FRONTEND_IMAGE = "${DOCKERHUB_USERNAME}/fullstack-frontend"
        BUILD_TAG = "${BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì¶ Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Test Backend') {
            steps {
                echo 'üß™ Testing backend...'
                dir('backend') {
                    sh 'npm install'
                    sh 'npm test'
                }
            }
        }
        
        stage('Test Frontend') {
            steps {
                echo 'üß™ Testing frontend...'
                dir('frontend') {
                    sh 'npm install'
                    sh 'npm run lint || echo "Linting completed with warnings"'
                }
            }
        }
        
        stage('Build Docker Images') {
            parallel {
                stage('Build Backend Image') {
                    steps {
                        echo 'üê≥ Building backend Docker image...'
                        dir('backend') {
                            script {
                                backendImage = docker.build("${BACKEND_IMAGE}:${BUILD_TAG}")
                                docker.build("${BACKEND_IMAGE}:latest")
                            }
                        }
                    }
                }
                stage('Build Frontend Image') {
                    steps {
                        echo 'üê≥ Building frontend Docker image...'
                        dir('frontend') {
                            script {
                                frontendImage = docker.build("${FRONTEND_IMAGE}:${BUILD_TAG}")
                                docker.build("${FRONTEND_IMAGE}:latest")
                            }
                        }
                    }
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                echo 'üì§ Pushing Docker images to Docker Hub...'
                script {
                    docker.withRegistry('https://registry.hub.docker.com', DOCKER_CREDENTIALS_ID) {
                        // Push backend
                        sh "docker push ${BACKEND_IMAGE}:${BUILD_TAG}"
                        sh "docker push ${BACKEND_IMAGE}:latest"
                        
                        // Push frontend
                        sh "docker push ${FRONTEND_IMAGE}:${BUILD_TAG}"
                        sh "docker push ${FRONTEND_IMAGE}:latest"
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                echo '‚ò∏Ô∏è Deploying to Kubernetes cluster...'
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS_ID, variable: 'KUBECONFIG')]) {
                    sh """
                        kubectl apply -f k8s/namespace.yaml
                        kubectl apply -f k8s/backend.yml
                        kubectl apply -f k8s/frontend.yml
                        kubectl apply -f k8s/ingress.yaml
                        
                        # Wait for rollout
                        kubectl rollout status deployment/backend-deployment
                        kubectl rollout status deployment/frontend-deployment
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo '‚úÖ Verifying deployment...'
                withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS_ID, variable: 'KUBECONFIG')]) {
                    sh """
                        echo "Backend Pods:"
                        kubectl get pods -l app=backend
                        
                        echo "Frontend Pods:"
                        kubectl get pods -l app=frontend
                        
                        echo "Services:"
                        kubectl get services
                        
                        echo "Ingress:"
                        kubectl get ingress
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully! üéâ'
            echo "Backend: ${BACKEND_IMAGE}:${BUILD_TAG}"
            echo "Frontend: ${FRONTEND_IMAGE}:${BUILD_TAG}"
        }
        failure {
            echo '‚ùå Pipeline failed! Check the logs above.'
        }
        always {
            echo 'üßπ Cleaning up workspace...'
            cleanWs()
        }
    }
}